name: Gravar Live

on:
  schedule:
    - cron: '0 21 * * 5'
    - cron: '0 21 * * 6'
    - cron: '0 21 * * 0'
  workflow_dispatch:

jobs:
  gravar:
    timeout-minutes: 180
    runs-on: ubuntu-latest
    env:
      URL_DO_CANAL: 'https://www.youtube.com/@Ralisco/live'
      NOME_DO_REMOTO: 'MeuDrive'
      PASTA_NO_DRIVE: 'LivesCoisaDeNerd'
      PASTA_LOGS: 'LogsGravacao'
      NOME_ARQUIVO_FORMATO: '%(uploader)s - %(upload_date)s - %(title)s.%(ext)s'
    steps:
      - name: Checkout código
        uses: actions/checkout@v3

      - name: Instalar dependências do sistema
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg python3 python3-pip curl

      - name: Instalar rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash
          rclone version

      - name: Instalar yt-dlp
        run: |
          sudo curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp
          sudo chmod a+rx /usr/local/bin/yt-dlp
          yt-dlp --version

      - name: Criar configuração do rclone
        run: |
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONFIG }}" > ~/.config/rclone/rclone.conf

      - name: Criar arquivo de cookies do YouTube
        if: ${{ secrets.YOUTUBE_COOKIES != '' }}
        run: |
          echo "${{ secrets.YOUTUBE_COOKIES }}" > $HOME/yt-cookies.txt

      - name: Enviar notificação para WhatsApp
        if: ${{ success() && secrets.TWILIO_ACCOUNT_SID != '' && secrets.WHATSAPP_API_KEY != '' }}
        run: |
          curl -X POST "https://api.twilio.com/2010-04-01/Accounts/${{ secrets.TWILIO_ACCOUNT_SID }}/Messages.json" \
            --data-urlencode "To=${{ secrets.WHATSAPP_RECEIVER_NUMBER_1 }}" \
            --data-urlencode "From=${{ secrets.WHATSAPP_SENDER_NUMBER }}" \
            --data-urlencode "Body=Iniciando a gravação da live!" \
            -u "${{ secrets.TWILIO_ACCOUNT_SID }}:${{ secrets.WHATSAPP_API_KEY }}"

      - name: Rodar script de gravação
        run: bash ./script.sh
