# Nome do Workflow
name: Gravar Live

# Gatilhos de execu√ß√£o
on:
  schedule:
    # Agendamento para toda Sexta, S√°bado e Domingo √†s 18h (Hor√°rio de Bras√≠lia)
    # O cron usa o fuso hor√°rio UTC. 21h UTC = 18h BRT.
    - cron: '0 21 * * 5' # Sexta
    - cron: '0 21 * * 6' # S√°bado
    - cron: '0 21 * * 0' # Domingo
  # Permite a execu√ß√£o manual do workflow pela interface do GitHub
  workflow_dispatch:

jobs:
  gravar:
    runs-on: ubuntu-latest
    # Define um tempo limite de 3 horas (180 minutos) para o job
    timeout-minutes: 180
    steps:
      # 1. Faz o checkout do c√≥digo do seu reposit√≥rio
      - name: Checkout
        uses: actions/checkout@v3

      # 2. Instala depend√™ncias b√°sicas do sistema
      - name: Setup depend√™ncias
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg python3 python3-pip curl

      # 3. Instala rclone (vers√£o mais recente)
      - name: Install rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash

      # 4. Instala yt-dlp (vers√£o mais recente)
      - name: Install yt-dlp
        run: |
          sudo curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp
          sudo chmod a+rx /usr/local/bin/yt-dlp

      # 5. Cria o arquivo de configura√ß√£o do rclone a partir do secret
      - name: Criar config rclone
        run: |
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONFIG }}" > ~/.config/rclone/rclone.conf

      # 6. Envia notifica√ß√£o para o WhatsApp (N√∫mero 1)
      - name: Enviar notifica√ß√£o para WhatsApp
        if: success() && secrets.WHATSAPP_API_KEY != ''
        run: |
          curl -X POST "https://api.twilio.com/2010-04-01/Accounts/${{ secrets.WHATSAPP_API_KEY }}/Messages.json" \
          --data-urlencode "To=${{ secrets.WHATSAPP_RECEIVER_NUMBER_1 }}" \
          --data-urlencode "From=${{ secrets.WHATSAPP_SENDER_NUMBER }}" \
          --data-urlencode "Body=üöÄ O script de grava√ß√£o da live foi iniciado!" \
          -u "${{ secrets.WHATSAPP_API_KEY }}:${{ secrets.WHATSAPP_API_KEY }}"

      # 7. Executa o script de grava√ß√£o principal
      - name: Rodar script de grava√ß√£o
        run: |
          bash ./script.sh

