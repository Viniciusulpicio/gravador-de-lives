name: Gravar Live

on:
  schedule:
    # 22:30 UTC = 19:30 Hor√°rio de Bras√≠lia
    - cron: '30 22 * * 5,6,0'
  workflow_dispatch:

jobs:
  gravar:
    timeout-minutes: 360
    runs-on: ubuntu-latest
    
    # Vari√°veis de ambiente globais (removi os segredos daqui por seguran√ßa)
    env:
      URL_DO_CANAL: 'https://www.youtube.com/@republicacoisadenerd/live'
      NOME_DO_REMOTO: 'MeuDrive'
      PASTA_NO_DRIVE: 'LivesCoisaDeNerd'
      PASTA_LOGS: 'LogsGravacao'
      NOME_ARQUIVO_FORMATO: '%(uploader)s - %(upload_date)s - %(title)s.%(ext)s'
      # Os segredos sens√≠veis ser√£o chamados apenas nos steps necess√°rios

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v3

      - name: Instalar depend√™ncias do sistema
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg python3 python3-pip curl

      - name: Instalar rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash
          rclone version

      - name: Instalar yt-dlp
        run: |
          sudo curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp
          sudo chmod a+rx /usr/local/bin/yt-dlp
          yt-dlp --version

      - name: Criar configura√ß√£o do rclone
        env:
          RCLONE_CONFIG_CONTENT: ${{ secrets.RCLONE_CONFIG }}
        run: |
          mkdir -p ~/.config/rclone
          echo "$RCLONE_CONFIG_CONTENT" > ~/.config/rclone/rclone.conf

      - name: Criar arquivo de cookies do YouTube
        # S√≥ executa se o segredo existir
        if: ${{ secrets.YOUTUBE_COOKIES != '' }}
        env:
          COOKIES_CONTENT: ${{ secrets.YOUTUBE_COOKIES }}
        run: |
          # Usamos printf para garantir que quebras de linha sejam respeitadas
          printf "%s" "$COOKIES_CONTENT" > $HOME/yt-cookies.txt
          echo "Arquivo de cookies criado em $HOME/yt-cookies.txt"

      - name: Enviar notifica√ß√£o para WhatsApp (In√≠cio)
        if: ${{ secrets.TWILIO_ACCOUNT_SID != '' }}
        env:
          TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
          WHATSAPP_API_KEY: ${{ secrets.WHATSAPP_API_KEY }}
          WHATSAPP_SENDER_NUMBER: ${{ secrets.WHATSAPP_SENDER_NUMBER }}
          WHATSAPP_RECEIVER_NUMBER_1: ${{ secrets.WHATSAPP_RECEIVER_NUMBER_1 }}
        run: |
          curl -X POST "https://api.twilio.com/2010-04-01/Accounts/${TWILIO_ACCOUNT_SID}/Messages.json" \
            --data-urlencode "To=${WHATSAPP_RECEIVER_NUMBER_1}" \
            --data-urlencode "From=${WHATSAPP_SENDER_NUMBER}" \
            --data-urlencode "Body=üé• Iniciando a tentativa de grava√ß√£o da live!" \
            -u "${TWILIO_ACCOUNT_SID}:${WHATSAPP_API_KEY}" || true

      - name: Rodar script de grava√ß√£o
        run: bash ./script.sh

      # Opcional: Notificar se terminar (para voc√™ saber se gravou ou n√£o)
      - name: Enviar notifica√ß√£o para WhatsApp (Fim)
        if: always() && ${{ secrets.TWILIO_ACCOUNT_SID != '' }}
        env:
          TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
          WHATSAPP_API_KEY: ${{ secrets.WHATSAPP_API_KEY }}
          WHATSAPP_SENDER_NUMBER: ${{ secrets.WHATSAPP_SENDER_NUMBER }}
          WHATSAPP_RECEIVER_NUMBER_1: ${{ secrets.WHATSAPP_RECEIVER_NUMBER_1 }}
        run: |
           STATUS="${{ job.status }}"
           curl -X POST "https://api.twilio.com/2010-04-01/Accounts/${TWILIO_ACCOUNT_SID}/Messages.json" \
            --data-urlencode "To=${WHATSAPP_RECEIVER_NUMBER_1}" \
            --data-urlencode "From=${WHATSAPP_SENDER_NUMBER}" \
            --data-urlencode "Body=üèÅ Workflow finalizado. Status: $STATUS" \
            -u "${TWILIO_ACCOUNT_SID}:${WHATSAPP_API_KEY}" || true
