name: Gravar Live Coisa de Nerd

on:
  schedule:
    # Sexta-feira às 18:30 BRT (21:30 UTC)
    - cron: '30 21 * * 5'
    # Sábado às 18:30 BRT (21:30 UTC)
    - cron: '30 21 * * 6'
    # Domingo às 18:30 BRT (21:30 UTC)
    - cron: '30 21 * * 0'
  workflow_dispatch:
    inputs:
      tempo_espera:
        description: 'Tempo máximo de espera em horas'
        required: false
        default: '3'

jobs:
  gravar:
    timeout-minutes: 360  # 6 horas máximo
    runs-on: ubuntu-latest
    
  env:
        URL_DO_CANAL: 'https://www.youtube.com/@republicacoisadenerd/streams'
        NOME_DO_REMOTO: 'MeuDrive'
        PASTA_NO_DRIVE: 'LivesCoisaDeNerd' 
        PASTA_LOGS: 'LogsGravacao'
        NOME_ARQUIVO_FORMATO: '%(uploader)s - %(upload_date)s - %(title)s.%(ext)s'
        RCLONE_CONFIG_CONTENT: ${{ secrets.RCLONE_CONFIG }} 
        WHATSAPP_API_KEY: ${{ secrets.WHATSAPP_API_KEY }}
        WHATSAPP_RECEIVER_NUMBER_1: ${{ secrets.WHATSAPP_RECEIVER_NUMBER_1 }}
        WHATSAPP_SENDER_NUMBER: ${{ secrets.WHATSAPP_SENDER_NUMBER }}
        TEMPO_MAXIMO_ESPERA: ${{ github.event.inputs.tempo_espera || '3' }}
      
    steps:
      - name: Checkout código
        uses: actions/checkout@v4
        
      - name: Configurar timezone
        run: |
          sudo timedatectl set-timezone America/Sao_Paulo
          date
          
      - name: Instalar dependências
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg python3 python3-pip curl jq
          
      - name: Instalar rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash
          rclone version
          
      - name: Instalar yt-dlp (versão mais recente)
        run: |
          sudo curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp
          sudo chmod a+rx /usr/local/bin/yt-dlp
          yt-dlp --version
          
      - name: Executar gravação
        run: |
          chmod +x ./script.sh
          bash ./script.sh
          
      - name: Upload de logs em caso de falha
        if: failure()
        run: |
          if [ -f /tmp/gravacao/gravacao.log ]; then
            # O script.sh já terá criado a config, então podemos usá-la aqui
            rclone copy /tmp/gravacao/gravacao.log "$NOME_DO_REMOTO:$PASTA_LOGS/falha_$(date +%Y-%m-%d_%H-%M-%S).log" \
              --config ~/.config/rclone/rclone.conf || true
          fi
